var data = {lines:[
{"lineNum":"    1","line":"//! Minimal bindings around libtls. These are not very ergonomic, and may"},
{"lineNum":"    2","line":"//! allow you to issue calls that can never succeed (e.g. read/write a server","class":"lineCov","hits":"1","order":"152",},
{"lineNum":"    3","line":"//! context)."},
{"lineNum":"    4","line":""},
{"lineNum":"    5","line":"extern crate tls_sys as ffi;"},
{"lineNum":"    6","line":"extern crate libc;"},
{"lineNum":"    7","line":""},
{"lineNum":"    8","line":"use std::ffi::CString;"},
{"lineNum":"    9","line":"use libc::{c_void, size_t};"},
{"lineNum":"   10","line":"use std::ptr;"},
{"lineNum":"   11","line":"use std::error::Error;"},
{"lineNum":"   12","line":"use std::fmt;"},
{"lineNum":"   13","line":"use std::convert;"},
{"lineNum":"   14","line":"use std::io;"},
{"lineNum":"   15","line":"#[cfg(unix)]"},
{"lineNum":"   16","line":"use std::os::unix::io::RawFd;"},
{"lineNum":"   17","line":"#[cfg(windows)]"},
{"lineNum":"   18","line":"use std::os::windows::io::RawSocket;"},
{"lineNum":"   19","line":"use std::sync::{Once, ONCE_INIT};"},
{"lineNum":"   20","line":"use super::util::*;"},
{"lineNum":"   21","line":"use chrono::datetime::DateTime;"},
{"lineNum":"   22","line":"use chrono::naive::datetime::NaiveDateTime;"},
{"lineNum":"   23","line":"use chrono::offset::utc::UTC;"},
{"lineNum":"   24","line":""},
{"lineNum":"   25","line":"#[derive(Debug)]","class":"lineNoCov","hits":"0",},
{"lineNum":"   26","line":"pub struct TlsError {"},
{"lineNum":"   27","line":"    msg: String,","class":"lineNoCov","hits":"0",},
{"lineNum":"   28","line":"    code: i64,","class":"lineNoCov","hits":"0",},
{"lineNum":"   29","line":"}"},
{"lineNum":"   30","line":""},
{"lineNum":"   31","line":"impl TlsError {"},
{"lineNum":"   32","line":"    /// The operation failed because it would block reading"},
{"lineNum":"   33","line":"    fn want_pollin(&self) -> bool {","class":"lineCov","hits":"1","order":"976",},
{"lineNum":"   34","line":"        self.code == ffi::WANT_POLLIN","class":"lineCov","hits":"1","order":"977",},
{"lineNum":"   35","line":"    }","class":"lineCov","hits":"1","order":"978",},
{"lineNum":"   36","line":"    /// The operation failed because it would block writing"},
{"lineNum":"   37","line":"    fn want_pollout(&self) -> bool {","class":"lineCov","hits":"1","order":"979",},
{"lineNum":"   38","line":"        self.code == ffi::WANT_POLLIN","class":"lineCov","hits":"1","order":"980",},
{"lineNum":"   39","line":"    }","class":"lineCov","hits":"1","order":"981",},
{"lineNum":"   40","line":"    /// The operation failed because it would block, repeating"},
{"lineNum":"   41","line":"    /// the same operation should succeed, but will block."},
{"lineNum":"   42","line":"    pub fn wants_more(&self) -> bool {","class":"lineCov","hits":"1","order":"983",},
{"lineNum":"   43","line":"        self.want_pollin() || self.want_pollout()","class":"lineCov","hits":"1","order":"985",},
{"lineNum":"   44","line":"    }","class":"lineCov","hits":"1","order":"987",},
{"lineNum":"   45","line":"    pub fn new<S: Into<String>>(msg: S) -> TlsError {","class":"lineCov","hits":"1","order":"88",},
{"lineNum":"   46","line":"        TlsError {"},
{"lineNum":"   47","line":"            msg: msg.into(),","class":"lineCov","hits":"1","order":"89",},
{"lineNum":"   48","line":"            code: -1,","class":"lineCov","hits":"1","order":"348",},
{"lineNum":"   49","line":"        }"},
{"lineNum":"   50","line":"    }","class":"lineCov","hits":"1","order":"349",},
{"lineNum":"   51","line":"}"},
{"lineNum":"   52","line":""},
{"lineNum":"   53","line":"impl fmt::Display for TlsError {"},
{"lineNum":"   54","line":"    fn fmt(&self, f: &mut fmt::Formatter) -> fmt::Result {","class":"lineNoCov","hits":"0",},
{"lineNum":"   55","line":"        write!(f, \"{}\", self.msg)","class":"lineNoCov","hits":"0",},
{"lineNum":"   56","line":"    }","class":"lineNoCov","hits":"0",},
{"lineNum":"   57","line":"}"},
{"lineNum":"   58","line":"impl Error for TlsError {"},
{"lineNum":"   59","line":"    fn description(&self) -> &str {","class":"lineNoCov","hits":"0",},
{"lineNum":"   60","line":"        &self.msg","class":"lineNoCov","hits":"0",},
{"lineNum":"   61","line":"    }","class":"lineNoCov","hits":"0",},
{"lineNum":"   62","line":"}"},
{"lineNum":"   63","line":"/// Convert TlsError to io::Error, use WouldBlock if applicable"},
{"lineNum":"   64","line":"impl convert::From<TlsError> for io::Error {"},
{"lineNum":"   65","line":"    fn from(err: TlsError) -> Self {","class":"lineCov","hits":"1","order":"990",},
{"lineNum":"   66","line":"        match err.code {","class":"lineCov","hits":"1","order":"991",},
{"lineNum":"   67","line":"            ffi::WANT_POLLIN | ffi::WANT_POLLOUT => io::Error::new(io::ErrorKind::WouldBlock, err),","class":"lineNoCov","hits":"0",},
{"lineNum":"   68","line":"            _ => io::Error::new(io::ErrorKind::Other, err.msg),","class":"lineCov","hits":"1","order":"992",},
{"lineNum":"   69","line":"        }"},
{"lineNum":"   70","line":"    }","class":"lineNoCov","hits":"0",},
{"lineNum":"   71","line":"}"},
{"lineNum":"   72","line":""},
{"lineNum":"   73","line":"/// result type for TLS operations"},
{"lineNum":"   74","line":"pub type TlsResult<T> = Result<T, TlsError>;"},
{"lineNum":"   75","line":""},
{"lineNum":"   76","line":"/// TLS configuration settings, see `TlsContext::configure` to apply them"},
{"lineNum":"   77","line":"pub struct TlsConfig {"},
{"lineNum":"   78","line":"    cfg: ffi::Config,"},
{"lineNum":"   79","line":"}"},
{"lineNum":"   80","line":""},
{"lineNum":"   81","line":"impl TlsConfig {"},
{"lineNum":"   82","line":"    pub fn new() -> TlsResult<TlsConfig> {","class":"lineCov","hits":"1","order":"157",},
{"lineNum":"   83","line":"        let p = unsafe { ffi::tls_config_new() };","class":"lineCov","hits":"1","order":"160",},
{"lineNum":"   84","line":"        if p == ptr::null_mut() {","class":"lineCov","hits":"1","order":"163",},
{"lineNum":"   85","line":"            Err(TlsError::new(\"Unable to create TLS config\"))","class":"lineNoCov","hits":"0",},
{"lineNum":"   86","line":"        } else {"},
{"lineNum":"   87","line":"            Ok(TlsConfig { cfg: p })","class":"lineCov","hits":"1","order":"166",},
{"lineNum":"   88","line":"        }"},
{"lineNum":"   89","line":"    }","class":"lineCov","hits":"1","order":"169",},
{"lineNum":"   90","line":""},
{"lineNum":"   91","line":"    pub fn set_ca_file(&mut self, path: &str) -> TlsResult<()> {","class":"lineCov","hits":"1","order":"182",},
{"lineNum":"   92","line":"        let rv = unsafe {"},
{"lineNum":"   93","line":"            let path_c = CString::from_vec_unchecked(path.bytes().collect());","class":"lineCov","hits":"1","order":"185",},
{"lineNum":"   94","line":"            ffi::tls_config_set_ca_file(self.cfg, path_c.as_ptr())","class":"lineCov","hits":"1","order":"230",},
{"lineNum":"   95","line":"        };","class":"lineCov","hits":"1","order":"231",},
{"lineNum":"   96","line":"        if rv == 0 {","class":"lineCov","hits":"1","order":"232",},
{"lineNum":"   97","line":"            Ok(())"},
{"lineNum":"   98","line":"        } else {"},
{"lineNum":"   99","line":"            Err(TlsError::new(\"Unable to set CA file\"))","class":"lineNoCov","hits":"0",},
{"lineNum":"  100","line":"        }"},
{"lineNum":"  101","line":"    }","class":"lineCov","hits":"1","order":"233",},
{"lineNum":"  102","line":"    pub fn set_ca_path(&mut self, path: &str) -> TlsResult<()> {","class":"lineCov","hits":"1","order":"995",},
{"lineNum":"  103","line":"        let rv = unsafe {"},
{"lineNum":"  104","line":"            let path_c = str_c_ptr(path);","class":"lineCov","hits":"1","order":"996",},
{"lineNum":"  105","line":"            ffi::tls_config_set_ca_path(self.cfg, path_c)","class":"lineCov","hits":"1","order":"997",},
{"lineNum":"  106","line":"        };"},
{"lineNum":"  107","line":"        if rv == 0 {","class":"lineCov","hits":"1","order":"998",},
{"lineNum":"  108","line":"            Ok(())"},
{"lineNum":"  109","line":"        } else {"},
{"lineNum":"  110","line":"            Err(TlsError::new(\"Unable to set CA path\"))","class":"lineNoCov","hits":"0",},
{"lineNum":"  111","line":"        }"},
{"lineNum":"  112","line":"    }","class":"lineCov","hits":"1","order":"999",},
{"lineNum":"  113","line":"    pub fn set_ca_mem(&mut self, ca: &str) -> TlsResult<()> {","class":"lineCov","hits":"1","order":"1000",},
{"lineNum":"  114","line":"        let rv = unsafe { ffi::tls_config_set_ca_mem(self.cfg, ca.as_ptr(), ca.len()) };","class":"lineCov","hits":"1","order":"1001",},
{"lineNum":"  115","line":"        if rv == 0 {","class":"lineCov","hits":"1","order":"1002",},
{"lineNum":"  116","line":"            Ok(())"},
{"lineNum":"  117","line":"        } else {"},
{"lineNum":"  118","line":"            Err(TlsError::new(\"Unable to set CA from memory\"))","class":"lineNoCov","hits":"0",},
{"lineNum":"  119","line":"        }"},
{"lineNum":"  120","line":"    }","class":"lineCov","hits":"1","order":"1003",},
{"lineNum":"  121","line":"    pub fn set_verify_depth(&mut self, depth: i32) {","class":"lineCov","hits":"1","order":"1004",},
{"lineNum":"  122","line":"        unsafe { ffi::tls_config_set_verify_depth(self.cfg, depth) }","class":"lineCov","hits":"1","order":"1005",},
{"lineNum":"  123","line":"    }","class":"lineCov","hits":"1","order":"1006",},
{"lineNum":"  124","line":"    pub fn insecure_noverifyname(&mut self) {","class":"lineCov","hits":"1","order":"1008",},
{"lineNum":"  125","line":"        unsafe { ffi::tls_config_insecure_noverifyname(self.cfg) }","class":"lineCov","hits":"1","order":"1010",},
{"lineNum":"  126","line":"    }","class":"lineCov","hits":"1","order":"1012",},
{"lineNum":"  127","line":"    pub fn insecure_noverifycert(&mut self) {","class":"lineCov","hits":"1","order":"1013",},
{"lineNum":"  128","line":"        unsafe { ffi::tls_config_insecure_noverifycert(self.cfg) }","class":"lineCov","hits":"1","order":"1014",},
{"lineNum":"  129","line":"    }","class":"lineCov","hits":"1","order":"1015",},
{"lineNum":"  130","line":"    pub fn set_key_file(&mut self, path: &str) -> TlsResult<()> {","class":"lineCov","hits":"1","order":"1133",},
{"lineNum":"  131","line":"        let rv = unsafe {"},
{"lineNum":"  132","line":"            let path_c = CString::from_vec_unchecked(path.bytes().collect());","class":"lineCov","hits":"1","order":"1134",},
{"lineNum":"  133","line":"            ffi::tls_config_set_key_file(self.cfg, path_c.as_ptr())","class":"lineCov","hits":"1","order":"1135",},
{"lineNum":"  134","line":"        };","class":"lineCov","hits":"1","order":"1136",},
{"lineNum":"  135","line":"        if rv == 0 {","class":"lineCov","hits":"1","order":"1137",},
{"lineNum":"  136","line":"            Ok(())"},
{"lineNum":"  137","line":"        } else {"},
{"lineNum":"  138","line":"            Err(TlsError::new(\"Unable to set key file\"))","class":"lineNoCov","hits":"0",},
{"lineNum":"  139","line":"        }"},
{"lineNum":"  140","line":"    }","class":"lineCov","hits":"1","order":"1138",},
{"lineNum":"  141","line":"    pub fn set_cert_file(&mut self, path: &str) -> TlsResult<()> {","class":"lineCov","hits":"1","order":"1139",},
{"lineNum":"  142","line":"        let rv = unsafe {"},
{"lineNum":"  143","line":"            let path_c = CString::from_vec_unchecked(path.bytes().collect());","class":"lineCov","hits":"1","order":"1140",},
{"lineNum":"  144","line":"            ffi::tls_config_set_cert_file(self.cfg, path_c.as_ptr())","class":"lineCov","hits":"1","order":"1141",},
{"lineNum":"  145","line":"        };","class":"lineCov","hits":"1","order":"1142",},
{"lineNum":"  146","line":"        if rv == 0 {","class":"lineCov","hits":"1","order":"1143",},
{"lineNum":"  147","line":"            Ok(())"},
{"lineNum":"  148","line":"        } else {"},
{"lineNum":"  149","line":"            Err(TlsError::new(\"Unable to set certificate file\"))","class":"lineNoCov","hits":"0",},
{"lineNum":"  150","line":"        }"},
{"lineNum":"  151","line":"    }","class":"lineCov","hits":"1","order":"1144",},
{"lineNum":"  152","line":"    pub fn set_protocols(&mut self, protocols: &str) -> TlsResult<()> {","class":"lineCov","hits":"1","order":"480",},
{"lineNum":"  153","line":"        let mut proto = 0;","class":"lineCov","hits":"1","order":"481",},
{"lineNum":"  154","line":"        unsafe {"},
{"lineNum":"  155","line":"            let proto_c = CString::from_vec_unchecked(protocols.bytes().collect());","class":"lineCov","hits":"1","order":"482",},
{"lineNum":"  156","line":"            if ffi::tls_config_parse_protocols(&mut proto, proto_c.as_ptr()) == -1 {","class":"lineCov","hits":"1","order":"483",},
{"lineNum":"  157","line":"                return Err(TlsError::new(format!(\"Invalid protocols: {}\", protocols)));","class":"lineCov","hits":"1","order":"528",},
{"lineNum":"  158","line":"            }"},
{"lineNum":"  159","line":"            ffi::tls_config_set_protocols(self.cfg, proto);","class":"lineCov","hits":"1","order":"507",},
{"lineNum":"  160","line":"        }","class":"lineCov","hits":"1","order":"508",},
{"lineNum":"  161","line":"        Ok(())"},
{"lineNum":"  162","line":"    }","class":"lineCov","hits":"1","order":"509",},
{"lineNum":"  163","line":"    pub fn set_ciphers(&mut self, ciphers: &str) -> TlsResult<()> {","class":"lineCov","hits":"1","order":"1028",},
{"lineNum":"  164","line":"        let rv = unsafe {"},
{"lineNum":"  165","line":"            let ciphers_c = CString::from_vec_unchecked(ciphers.bytes().collect());","class":"lineCov","hits":"1","order":"1030",},
{"lineNum":"  166","line":"            ffi::tls_config_set_ciphers(self.cfg, ciphers_c.as_ptr())","class":"lineCov","hits":"1","order":"1032",},
{"lineNum":"  167","line":"        };","class":"lineCov","hits":"1","order":"1034",},
{"lineNum":"  168","line":"        if rv == 0 {","class":"lineCov","hits":"1","order":"1036",},
{"lineNum":"  169","line":"            Ok(())"},
{"lineNum":"  170","line":"        } else {"},
{"lineNum":"  171","line":"            return Err(TlsError::new(format!(\"Invalid ciphers: {}\", ciphers)));","class":"lineNoCov","hits":"0",},
{"lineNum":"  172","line":"        }"},
{"lineNum":"  173","line":"    }","class":"lineCov","hits":"1","order":"1040",},
{"lineNum":"  174","line":"}"},
{"lineNum":"  175","line":""},
{"lineNum":"  176","line":"impl Drop for TlsConfig {"},
{"lineNum":"  177","line":"    fn drop(&mut self) {","class":"lineCov","hits":"1","order":"300",},
{"lineNum":"  178","line":"        unsafe {"},
{"lineNum":"  179","line":"            ffi::tls_config_free(self.cfg);","class":"lineCov","hits":"1","order":"301",},
{"lineNum":"  180","line":"        }"},
{"lineNum":"  181","line":"    }","class":"lineCov","hits":"1","order":"337",},
{"lineNum":"  182","line":"}"},
{"lineNum":"  183","line":""},
{"lineNum":"  184","line":"/// A structure that represents all TLS context"},
{"lineNum":"  185","line":"///"},
{"lineNum":"  186","line":"/// This can be a client connection, a server, or a connection accepted by the server"},
{"lineNum":"  187","line":"pub struct TlsContext {"},
{"lineNum":"  188","line":"    ptr: ffi::Tls,"},
{"lineNum":"  189","line":"    cfg: Option<TlsConfig>,"},
{"lineNum":"  190","line":"}"},
{"lineNum":"  191","line":""},
{"lineNum":"  192","line":"impl TlsContext {"},
{"lineNum":"  193","line":"    /// Create a new client context"},
{"lineNum":"  194","line":"    pub fn new_client() -> TlsResult<TlsContext> {","class":"lineCov","hits":"1","order":"5",},
{"lineNum":"  195","line":"        let p = unsafe { ffi::tls_client() };","class":"lineCov","hits":"1","order":"7",},
{"lineNum":"  196","line":"        if p == ptr::null_mut() {","class":"lineCov","hits":"1","order":"49",},
{"lineNum":"  197","line":"            Err(TlsError::new(\"Unable to create TLS client\"))","class":"lineNoCov","hits":"0",},
{"lineNum":"  198","line":"        } else {"},
{"lineNum":"  199","line":"            Ok(TlsContext {"},
{"lineNum":"  200","line":"                ptr: p,","class":"lineCov","hits":"1","order":"50",},
{"lineNum":"  201","line":"                cfg: None,"},
{"lineNum":"  202","line":"            })"},
{"lineNum":"  203","line":"        }"},
{"lineNum":"  204","line":"    }","class":"lineCov","hits":"1","order":"51",},
{"lineNum":"  205","line":""},
{"lineNum":"  206","line":"    fn error(&self) -> String {","class":"lineCov","hits":"1","order":"227",},
{"lineNum":"  207","line":"        unsafe { from_cstr(ffi::tls_error(self.ptr)) }","class":"lineCov","hits":"1","order":"228",},
{"lineNum":"  208","line":"    }","class":"lineCov","hits":"1","order":"292",},
{"lineNum":"  209","line":""},
{"lineNum":"  210","line":"    fn rv_to_result(&self, rv: i64) -> TlsResult<()> {","class":"lineCov","hits":"1","order":"224",},
{"lineNum":"  211","line":"        if rv == 0 {","class":"lineCov","hits":"1","order":"225",},
{"lineNum":"  212","line":"            Ok(())"},
{"lineNum":"  213","line":"        } else {"},
{"lineNum":"  214","line":"            Err(TlsError {"},
{"lineNum":"  215","line":"                msg: self.error(),","class":"lineCov","hits":"1","order":"226",},
{"lineNum":"  216","line":"                code: rv,","class":"lineCov","hits":"1","order":"293",},
{"lineNum":"  217","line":"            })"},
{"lineNum":"  218","line":"        }"},
{"lineNum":"  219","line":"    }","class":"lineCov","hits":"1","order":"294",},
{"lineNum":"  220","line":""},
{"lineNum":"  221","line":"    /// If port is empty, the port value is assumed to be part of the hostname string as host:port."},
{"lineNum":"  222","line":"    /// If servername is not empty it is used instead of the hostname for verification."},
{"lineNum":"  223","line":"    pub fn connect_servername(&mut self,"},
{"lineNum":"  224","line":"                              hostname: &str,"},
{"lineNum":"  225","line":"                              port: &str,"},
{"lineNum":"  226","line":"                              servername: &str)"},
{"lineNum":"  227","line":"                              -> TlsResult<()> {","class":"lineCov","hits":"1","order":"236",},
{"lineNum":"  228","line":"        let rv = unsafe {"},
{"lineNum":"  229","line":"            let hostname_c = CString::from_vec_unchecked(hostname.bytes().collect()).as_ptr();","class":"lineCov","hits":"1","order":"237",},
{"lineNum":"  230","line":"            // Both port and servername can be NULL"},
{"lineNum":"  231","line":"            let port_c = str_c_ptr(port);","class":"lineCov","hits":"1","order":"238",},
{"lineNum":"  232","line":"            let servername_c = str_c_ptr(servername);","class":"lineCov","hits":"1","order":"244",},
{"lineNum":"  233","line":"            ffi::tls_connect_servername(self.ptr, hostname_c, port_c, servername_c)","class":"lineCov","hits":"1","order":"246",},
{"lineNum":"  234","line":"        };"},
{"lineNum":"  235","line":"        self.rv_to_result(rv as i64)","class":"lineCov","hits":"1","order":"287",},
{"lineNum":"  236","line":"    }","class":"lineCov","hits":"1","order":"295",},
{"lineNum":"  237","line":""},
{"lineNum":"  238","line":"    #[cfg(unix)]"},
{"lineNum":"  239","line":"    /// Establish a TLS connection over the given socket"},
{"lineNum":"  240","line":"    pub fn connect_socket(&mut self, fd: RawFd, servername: &str) -> TlsResult<()> {","class":"lineCov","hits":"1","order":"982",},
{"lineNum":"  241","line":"        let rv = unsafe {"},
{"lineNum":"  242","line":"            let servername_c = str_c_ptr(servername);","class":"lineCov","hits":"1","order":"984",},
{"lineNum":"  243","line":"            ffi::tls_connect_socket(self.ptr, fd, servername_c)","class":"lineCov","hits":"1","order":"986",},
{"lineNum":"  244","line":"        };"},
{"lineNum":"  245","line":"        self.rv_to_result(rv as i64)","class":"lineCov","hits":"1","order":"988",},
{"lineNum":"  246","line":"    }","class":"lineCov","hits":"1","order":"989",},
{"lineNum":"  247","line":""},
{"lineNum":"  248","line":"    #[cfg(windows)]"},
{"lineNum":"  249","line":"    /// Establish a TLS connection over the given socket"},
{"lineNum":"  250","line":"    pub fn connect_socket(&mut self, sock: RawSocket, servername: &str) -> TlsResult<()> {"},
{"lineNum":"  251","line":"        let rv = unsafe {"},
{"lineNum":"  252","line":"            let servername_c = str_c_ptr(servername);"},
{"lineNum":"  253","line":"            // This cast is not exactly safe"},
{"lineNum":"  254","line":"            // http://stackoverflow.com/questions/1953639/"},
{"lineNum":"  255","line":"            ffi::tls_connect_socket(self.ptr, sock as i32, servername_c)"},
{"lineNum":"  256","line":"        };"},
{"lineNum":"  257","line":"        self.rv_to_result(rv as i64)"},
{"lineNum":"  258","line":"    }"},
{"lineNum":"  259","line":""},
{"lineNum":"  260","line":"    pub fn conn_version(&self) -> String {","class":"lineCov","hits":"1","order":"52",},
{"lineNum":"  261","line":"        unsafe { from_cstr(ffi::tls_conn_version(self.ptr)) }","class":"lineCov","hits":"1","order":"53",},
{"lineNum":"  262","line":"    }","class":"lineCov","hits":"1","order":"63",},
{"lineNum":"  263","line":"    pub fn conn_cipher(&self) -> String {","class":"lineCov","hits":"1","order":"71",},
{"lineNum":"  264","line":"        unsafe { from_cstr(ffi::tls_conn_cipher(self.ptr)) }","class":"lineCov","hits":"1","order":"72",},
{"lineNum":"  265","line":"    }","class":"lineCov","hits":"1","order":"77",},
{"lineNum":"  266","line":""},
{"lineNum":"  267","line":"    /// Apply configuration settings to the context, consuming the config struct"},
{"lineNum":"  268","line":"    ///"},
{"lineNum":"  269","line":"    /// This should be called BEFORE trying to establish/accept"},
{"lineNum":"  270","line":"    /// a connection"},
{"lineNum":"  271","line":"    pub fn configure(&mut self, cfg: TlsConfig) -> TlsResult<()> {","class":"lineCov","hits":"1","order":"549",},
{"lineNum":"  272","line":"        let rv = unsafe { ffi::tls_configure(self.ptr, cfg.cfg) };","class":"lineCov","hits":"1","order":"550",},
{"lineNum":"  273","line":"        self.cfg = Some(cfg);","class":"lineCov","hits":"1","order":"557",},
{"lineNum":"  274","line":"        self.rv_to_result(rv as i64)","class":"lineCov","hits":"1","order":"558",},
{"lineNum":"  275","line":"    }","class":"lineCov","hits":"1","order":"559",},
{"lineNum":"  276","line":""},
{"lineNum":"  277","line":"    pub fn peer_cert_notbefore(&self) -> TlsResult<DateTime<UTC>> {","class":"lineCov","hits":"1","order":"79",},
{"lineNum":"  278","line":"        let rv = unsafe { ffi::tls_peer_cert_notbefore(self.ptr) };","class":"lineCov","hits":"1","order":"80",},
{"lineNum":"  279","line":"        if rv == -1 {","class":"lineCov","hits":"1","order":"86",},
{"lineNum":"  280","line":"            Err(TlsError::new(\"Unable to get certificate information\"))","class":"lineCov","hits":"1","order":"87",},
{"lineNum":"  281","line":"        } else {"},
{"lineNum":"  282","line":"            Ok(DateTime::from_utc(NaiveDateTime::from_timestamp(rv as i64, 0), UTC))","class":"lineCov","hits":"1","order":"993",},
{"lineNum":"  283","line":"        }"},
{"lineNum":"  284","line":"    }","class":"lineCov","hits":"1","order":"350",},
{"lineNum":"  285","line":""},
{"lineNum":"  286","line":"    pub fn peer_cert_notafter(&self) -> TlsResult<DateTime<UTC>> {","class":"lineCov","hits":"1","order":"352",},
{"lineNum":"  287","line":"        let rv = unsafe { ffi::tls_peer_cert_notafter(self.ptr) };","class":"lineCov","hits":"1","order":"353",},
{"lineNum":"  288","line":"        if rv == -1 {","class":"lineCov","hits":"1","order":"358",},
{"lineNum":"  289","line":"            Err(TlsError::new(\"Unable to get certificate information\"))","class":"lineCov","hits":"1","order":"359",},
{"lineNum":"  290","line":"        } else {"},
{"lineNum":"  291","line":"            Ok(DateTime::from_utc(NaiveDateTime::from_timestamp(rv as i64, 0), UTC))","class":"lineCov","hits":"1","order":"994",},
{"lineNum":"  292","line":"        }"},
{"lineNum":"  293","line":"    }","class":"lineCov","hits":"1","order":"360",},
{"lineNum":"  294","line":""},
{"lineNum":"  295","line":"    pub fn peer_cert_hash(&self) -> String {","class":"lineCov","hits":"1","order":"375",},
{"lineNum":"  296","line":"        unsafe { from_cstr(ffi::tls_peer_cert_hash(self.ptr)) }","class":"lineCov","hits":"1","order":"376",},
{"lineNum":"  297","line":"    }","class":"lineCov","hits":"1","order":"381",},
{"lineNum":"  298","line":""},
{"lineNum":"  299","line":"    pub fn peer_cert_issuer(&self) -> String {","class":"lineCov","hits":"1","order":"361",},
{"lineNum":"  300","line":"        unsafe { from_cstr(ffi::tls_peer_cert_issuer(self.ptr)) }","class":"lineCov","hits":"1","order":"362",},
{"lineNum":"  301","line":"    }","class":"lineCov","hits":"1","order":"367",},
{"lineNum":"  302","line":""},
{"lineNum":"  303","line":"    pub fn peer_cert_subject(&self) -> String {","class":"lineCov","hits":"1","order":"368",},
{"lineNum":"  304","line":"        unsafe { from_cstr(ffi::tls_peer_cert_subject(self.ptr)) }","class":"lineCov","hits":"1","order":"369",},
{"lineNum":"  305","line":"    }","class":"lineCov","hits":"1","order":"374",},
{"lineNum":"  306","line":""},
{"lineNum":"  307","line":"    pub fn peer_cert_contains_name(&self, name: &str) -> bool {","class":"lineCov","hits":"1","order":"382",},
{"lineNum":"  308","line":"        let rv = unsafe {"},
{"lineNum":"  309","line":"            let name_c = CString::from_vec_unchecked(name.bytes().collect());","class":"lineCov","hits":"1","order":"383",},
{"lineNum":"  310","line":"            ffi::tls_peer_cert_contains_name(self.ptr, name_c.as_ptr())","class":"lineCov","hits":"1","order":"384",},
{"lineNum":"  311","line":"        };","class":"lineCov","hits":"1","order":"389",},
{"lineNum":"  312","line":"        (rv == 1)","class":"lineCov","hits":"1","order":"390",},
{"lineNum":"  313","line":"    }","class":"lineCov","hits":"1","order":"391",},
{"lineNum":"  314","line":""},
{"lineNum":"  315","line":"    pub fn peer_cert_provided(&self) -> bool {","class":"lineCov","hits":"1","order":"392",},
{"lineNum":"  316","line":"        let rv = unsafe { ffi::tls_peer_cert_provided(self.ptr) };","class":"lineCov","hits":"1","order":"393",},
{"lineNum":"  317","line":"        (rv == 1)","class":"lineCov","hits":"1","order":"397",},
{"lineNum":"  318","line":"    }","class":"lineCov","hits":"1","order":"398",},
{"lineNum":"  319","line":""},
{"lineNum":"  320","line":"    fn rv_to_result_io(&self, rv: i64) -> TlsResult<usize> {","class":"lineCov","hits":"1","order":"700",},
{"lineNum":"  321","line":"        match rv {","class":"lineCov","hits":"1","order":"702",},
{"lineNum":"  322","line":"            ffi::WANT_POLLIN => {"},
{"lineNum":"  323","line":"                Err(TlsError {","class":"lineCov","hits":"1","order":"1007",},
{"lineNum":"  324","line":"                    msg: String::new(),","class":"lineCov","hits":"1","order":"1009",},
{"lineNum":"  325","line":"                    code: rv,","class":"lineCov","hits":"1","order":"1011",},
{"lineNum":"  326","line":"                })"},
{"lineNum":"  327","line":"            }"},
{"lineNum":"  328","line":"            ffi::WANT_POLLOUT => {"},
{"lineNum":"  329","line":"                Err(TlsError {","class":"lineNoCov","hits":"0",},
{"lineNum":"  330","line":"                    msg: String::new(),","class":"lineNoCov","hits":"0",},
{"lineNum":"  331","line":"                    code: rv,","class":"lineNoCov","hits":"0",},
{"lineNum":"  332","line":"                })"},
{"lineNum":"  333","line":"            }"},
{"lineNum":"  334","line":"            rv if rv < 0 => {","class":"lineCov","hits":"1","order":"701",},
{"lineNum":"  335","line":"                Err(TlsError {","class":"lineCov","hits":"1","order":"1016",},
{"lineNum":"  336","line":"                    msg: self.error(),","class":"lineCov","hits":"1","order":"1017",},
{"lineNum":"  337","line":"                    code: -1,","class":"lineCov","hits":"1","order":"1018",},
{"lineNum":"  338","line":"                })"},
{"lineNum":"  339","line":"            }"},
{"lineNum":"  340","line":"            rv => Ok(rv as usize),","class":"lineCov","hits":"1","order":"703",},
{"lineNum":"  341","line":"        }"},
{"lineNum":"  342","line":"    }","class":"lineCov","hits":"1","order":"704",},
{"lineNum":"  343","line":""},
{"lineNum":"  344","line":"    /// Complete the TLS handshake"},
{"lineNum":"  345","line":"    ///"},
{"lineNum":"  346","line":"    /// This function will be called when needed by `read()` or `write()`, but"},
{"lineNum":"  347","line":"    /// can be called to complete the handshake."},
{"lineNum":"  348","line":"    pub fn handshake(&mut self) -> TlsResult<()> {","class":"lineCov","hits":"1","order":"561",},
{"lineNum":"  349","line":"        let rv = unsafe { ffi::tls_handshake(self.ptr) };","class":"lineCov","hits":"1","order":"562",},
{"lineNum":"  350","line":"        self.rv_to_result_io(rv as i64).map(|_| ())","class":"lineCov","hits":"1","order":"699",},
{"lineNum":"  351","line":"    }","class":"lineCov","hits":"1","order":"705",},
{"lineNum":"  352","line":""},
{"lineNum":"  353","line":"    pub fn close(&mut self) -> TlsResult<()> {","class":"lineCov","hits":"1","order":"1019",},
{"lineNum":"  354","line":"        let rv = unsafe { ffi::tls_close(self.ptr) };","class":"lineCov","hits":"1","order":"1020",},
{"lineNum":"  355","line":"        self.rv_to_result_io(rv as i64).map(|_| ())","class":"lineCov","hits":"1","order":"1021",},
{"lineNum":"  356","line":"    }","class":"lineCov","hits":"1","order":"1022",},
{"lineNum":"  357","line":""},
{"lineNum":"  358","line":"    pub fn read(&mut self, buf: &mut [u8]) -> TlsResult<usize> {","class":"lineCov","hits":"1","order":"1023",},
{"lineNum":"  359","line":"        let buflen = buf.len() as size_t;","class":"lineCov","hits":"1","order":"1024",},
{"lineNum":"  360","line":"        let bptr = buf.as_mut_ptr() as *mut c_void;","class":"lineCov","hits":"1","order":"1025",},
{"lineNum":"  361","line":"        let rv = unsafe { ffi::tls_read(self.ptr, bptr, buflen) };","class":"lineCov","hits":"1","order":"1026",},
{"lineNum":"  362","line":"        self.rv_to_result_io(rv as i64)","class":"lineCov","hits":"1","order":"1027",},
{"lineNum":"  363","line":"    }","class":"lineCov","hits":"1","order":"1029",},
{"lineNum":"  364","line":""},
{"lineNum":"  365","line":"    pub fn write(&mut self, buf: &[u8]) -> TlsResult<usize> {","class":"lineCov","hits":"1","order":"1031",},
{"lineNum":"  366","line":"        let buflen = buf.len() as size_t;","class":"lineCov","hits":"1","order":"1033",},
{"lineNum":"  367","line":"        let bptr = buf.as_ptr() as *const c_void;","class":"lineCov","hits":"1","order":"1035",},
{"lineNum":"  368","line":"        let rv = unsafe { ffi::tls_write(self.ptr, bptr, buflen) };","class":"lineCov","hits":"1","order":"1037",},
{"lineNum":"  369","line":"        self.rv_to_result_io(rv as i64)","class":"lineCov","hits":"1","order":"1038",},
{"lineNum":"  370","line":"    }","class":"lineCov","hits":"1","order":"1039",},
{"lineNum":"  371","line":""},
{"lineNum":"  372","line":"    /// Create new server context"},
{"lineNum":"  373","line":"    pub fn new_server() -> TlsResult<TlsContext> {","class":"lineCov","hits":"1","order":"159",},
{"lineNum":"  374","line":"        let p = unsafe { ffi::tls_server() };","class":"lineCov","hits":"1","order":"162",},
{"lineNum":"  375","line":"        if p == ptr::null_mut() {","class":"lineCov","hits":"1","order":"177",},
{"lineNum":"  376","line":"            Err(TlsError::new(\"Unable to create TLS server\"))","class":"lineNoCov","hits":"0",},
{"lineNum":"  377","line":"        } else {"},
{"lineNum":"  378","line":"            Ok(TlsContext {"},
{"lineNum":"  379","line":"                ptr: p,","class":"lineCov","hits":"1","order":"180",},
{"lineNum":"  380","line":"                cfg: None,"},
{"lineNum":"  381","line":"            })"},
{"lineNum":"  382","line":"        }"},
{"lineNum":"  383","line":"    }","class":"lineCov","hits":"1","order":"184",},
{"lineNum":"  384","line":""},
{"lineNum":"  385","line":"    #[cfg(unix)]"},
{"lineNum":"  386","line":"    /// Accept a new TLS connection over an existing socket"},
{"lineNum":"  387","line":"    pub fn accept_socket(&mut self, fd: RawFd) -> TlsResult<TlsContext> {","class":"lineCov","hits":"1","order":"161",},
{"lineNum":"  388","line":"        let mut cctx: ffi::Tls = ptr::null_mut();;","class":"lineCov","hits":"1","order":"164",},
{"lineNum":"  389","line":"        let rv = unsafe { ffi::tls_accept_socket(self.ptr, &mut cctx, fd) };","class":"lineCov","hits":"1","order":"167",},
{"lineNum":"  390","line":"        self.rv_to_result(rv as i64)","class":"lineCov","hits":"1","order":"223",},
{"lineNum":"  391","line":"            .map(|_| {","class":"lineCov","hits":"1","order":"1145",},
{"lineNum":"  392","line":"                TlsContext {"},
{"lineNum":"  393","line":"                    ptr: cctx,","class":"lineCov","hits":"1","order":"1146",},
{"lineNum":"  394","line":"                    cfg: None,"},
{"lineNum":"  395","line":"                }"},
{"lineNum":"  396","line":"            })","class":"lineCov","hits":"1","order":"1147",},
{"lineNum":"  397","line":"    }","class":"lineCov","hits":"1","order":"338",},
{"lineNum":"  398","line":""},
{"lineNum":"  399","line":"    #[cfg(windows)]"},
{"lineNum":"  400","line":"    /// Accept a new TLS connection over an existing socket"},
{"lineNum":"  401","line":"    pub fn accept_socket(&mut self, sock: RawSocket) -> TlsResult<TlsContext> {"},
{"lineNum":"  402","line":"        let mut cctx: ffi::Tls = ptr::null_mut();;"},
{"lineNum":"  403","line":"        // This cast is not exactly safe"},
{"lineNum":"  404","line":"        // http://stackoverflow.com/questions/1953639/"},
{"lineNum":"  405","line":"        let rv = unsafe {"},
{"lineNum":"  406","line":"            ffi::tls_accept_socket(self.ptr, &mut cctx, sock as i32)"},
{"lineNum":"  407","line":"        };"},
{"lineNum":"  408","line":"        self.rv_to_result(rv as i64)"},
{"lineNum":"  409","line":"            .map(|_| {"},
{"lineNum":"  410","line":"                TlsContext {"},
{"lineNum":"  411","line":"                    ptr: cctx,"},
{"lineNum":"  412","line":"                    cfg: None,"},
{"lineNum":"  413","line":"                }"},
{"lineNum":"  414","line":"            })"},
{"lineNum":"  415","line":"    }"},
{"lineNum":"  416","line":"}"},
{"lineNum":"  417","line":""},
{"lineNum":"  418","line":"impl Drop for TlsContext {"},
{"lineNum":"  419","line":"    fn drop(&mut self) {","class":"lineCov","hits":"1","order":"297",},
{"lineNum":"  420","line":"        unsafe {"},
{"lineNum":"  421","line":"            ffi::tls_free(self.ptr);","class":"lineCov","hits":"1","order":"298",},
{"lineNum":"  422","line":"        }"},
{"lineNum":"  423","line":"    }","class":"lineCov","hits":"1","order":"299",},
{"lineNum":"  424","line":"}"},
{"lineNum":"  425","line":""},
{"lineNum":"  426","line":"/// Initialize libtls - make sure to call this before using the API"},
{"lineNum":"  427","line":"/// Returns false if libtls failed to initialise."},
{"lineNum":"  428","line":"pub fn init() -> bool {","class":"lineCov","hits":"1","order":"6",},
{"lineNum":"  429","line":"    static mut RET: i32 = -1;"},
{"lineNum":"  430","line":"    static ONCE: Once = ONCE_INIT;"},
{"lineNum":"  431","line":"    ONCE.call_once(|| {","class":"lineCov","hits":"1","order":"13",},
{"lineNum":"  432","line":"        other_init();","class":"lineCov","hits":"1","order":"62",},
{"lineNum":"  433","line":"        unsafe { RET = ffi::tls_init() };","class":"lineCov","hits":"1","order":"65",},
{"lineNum":"  434","line":"    });","class":"lineCov","hits":"1","order":"149",},
{"lineNum":"  435","line":"    unsafe { (RET == 0) }","class":"lineCov","hits":"1","order":"150",},
{"lineNum":"  436","line":"}","class":"lineCov","hits":"1","order":"151",},
{"lineNum":"  437","line":""},
{"lineNum":"  438","line":"#[test]"},
{"lineNum":"  439","line":"fn connect_servername() {","class":"lineCov","hits":"1","order":"2",},
{"lineNum":"  440","line":"    assert!(init());","class":"lineCov","hits":"1","order":"4",},
{"lineNum":"  441","line":"    let mut cfg = TlsConfig::new().unwrap();","class":"lineCov","hits":"1","order":"156",},
{"lineNum":"  442","line":"    cfg.set_ca_file(\"tests/cert.pem\").unwrap();","class":"lineCov","hits":"1","order":"181",},
{"lineNum":"  443","line":"    let mut cli = TlsContext::new_client().unwrap();","class":"lineCov","hits":"1","order":"340",},
{"lineNum":"  444","line":"    cli.connect_servername(\"www.google.com\", \"443\", \"\")","class":"lineCov","hits":"1","order":"341",},
{"lineNum":"  445","line":"       .unwrap();"},
{"lineNum":"  446","line":"    cli.configure(cfg).unwrap();","class":"lineCov","hits":"1","order":"548",},
{"lineNum":"  447","line":"    cli.handshake().unwrap();","class":"lineCov","hits":"1","order":"560",},
{"lineNum":"  448","line":"}","class":"lineCov","hits":"1","order":"706",},
{"lineNum":"  449","line":""},
{"lineNum":"  450","line":"#[test]"},
{"lineNum":"  451","line":"fn error_connect_no_host() {","class":"lineCov","hits":"1","order":"17",},
{"lineNum":"  452","line":"    assert!(init());","class":"lineCov","hits":"1","order":"19",},
{"lineNum":"  453","line":"    let mut cfg = TlsConfig::new().unwrap();","class":"lineCov","hits":"1","order":"153",},
{"lineNum":"  454","line":"    cfg.set_ca_file(\"tests/cert.pem\").unwrap();","class":"lineCov","hits":"1","order":"178",},
{"lineNum":"  455","line":"    let mut cli = TlsContext::new_client().unwrap();","class":"lineCov","hits":"1","order":"234",},
{"lineNum":"  456","line":"    assert!(cli.connect_servername(\"\", \"443\", \"\")","class":"lineCov","hits":"1","order":"235",},
{"lineNum":"  457","line":"            .is_err());"},
{"lineNum":"  458","line":"}","class":"lineCov","hits":"1","order":"296",},
{"lineNum":"  459","line":""},
{"lineNum":"  460","line":"#[test]"},
{"lineNum":"  461","line":"fn error_connect_no_port() {","class":"lineCov","hits":"1","order":"18",},
{"lineNum":"  462","line":"    assert!(init());","class":"lineCov","hits":"1","order":"20",},
{"lineNum":"  463","line":"    let mut cfg = TlsConfig::new().unwrap();","class":"lineCov","hits":"1","order":"400",},
{"lineNum":"  464","line":"    cfg.set_ca_file(\"tests/cert.pem\").unwrap();","class":"lineCov","hits":"1","order":"401",},
{"lineNum":"  465","line":"    let mut cli = TlsContext::new_client().unwrap();","class":"lineCov","hits":"1","order":"402",},
{"lineNum":"  466","line":"    assert!(cli.connect_servername(\"www.google.com\", \"\", \"\")","class":"lineCov","hits":"1","order":"403",},
{"lineNum":"  467","line":"            .is_err());"},
{"lineNum":"  468","line":"}","class":"lineCov","hits":"1","order":"421",},
{"lineNum":"  469","line":""},
{"lineNum":"  470","line":"#[test]"},
{"lineNum":"  471","line":"fn error_accept_on_client() {","class":"lineCov","hits":"1","order":"10",},
{"lineNum":"  472","line":"    assert!(init());","class":"lineCov","hits":"1","order":"12",},
{"lineNum":"  473","line":"    let mut cli = TlsContext::new_client().unwrap();","class":"lineCov","hits":"1","order":"154",},
{"lineNum":"  474","line":"    assert!(cli.accept_socket(-1).is_err());","class":"lineCov","hits":"1","order":"158",},
{"lineNum":"  475","line":"}","class":"lineCov","hits":"1","order":"339",},
{"lineNum":"  476","line":""},
{"lineNum":"  477","line":"#[test]"},
{"lineNum":"  478","line":"fn error_accept_invalid_server() {","class":"lineCov","hits":"1","order":"9",},
{"lineNum":"  479","line":"    assert!(init());","class":"lineCov","hits":"1","order":"11",},
{"lineNum":"  480","line":"    let mut cli = TlsContext::new_server().unwrap();","class":"lineCov","hits":"1","order":"155",},
{"lineNum":"  481","line":"    assert!(cli.accept_socket(-1).is_err());","class":"lineCov","hits":"1","order":"187",},
{"lineNum":"  482","line":"}","class":"lineCov","hits":"1","order":"342",},
]};
var percent_low = 25;var percent_high = 75;
var header = { "command" : "tls-90dc0ae2bd2b42a3", "date" : "2016-01-27 11:14:15", "instrumented" : 252, "covered" : 229,};
var merged_data = [];
